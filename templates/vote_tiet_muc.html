{% extends "base.html" %}

{% block title %}Vote Ti·∫øt M·ª•c{% endblock %}

{% block body %}
<div class="container">
    <h1>üé≠ Vote Ti·∫øt M·ª•c Y√™u Th√≠ch</h1>
    <div class="info">
        <strong>{{ name }}</strong> - {{ department }}
    </div>
    <div class="warning">‚ö†Ô∏è B·∫°n kh√¥ng th·ªÉ b√¨nh ch·ªçn cho ti·∫øt m·ª•c thu·ªôc nh√≥m ph√≤ng ban c·ªßa m√¨nh</div>
    <div class="hint">‚úÖ B·∫°n ph·∫£i ch·ªçn <b>ƒë√∫ng 3</b> ti·∫øt m·ª•c ƒë·ªÉ ti·∫øp t·ª•c</div>
    <div class="counter">ƒê√£ ch·ªçn: <span id="count">0</span>/3</div>

    <form method="POST" id="form">
        <div class="vote-grid">
            {% for dept in departments %}
            <div class="vote-card {% if dept in forbidden_options %}disabled{% endif %} {% if dept in existing_votes %}selected{% endif %}"
                data-dept="{{ dept }}"
                onclick="toggleSelect(this)">
                {% if dept in forbidden_options %}
                <span class="my-dept-badge">Kh√¥ng ƒë∆∞·ª£c vote</span>
                {% endif %}
                <div class="dept-content">
                    <div class="dept-img">
                        <img src="{{ images.get(dept, '/static/img/tietmuc/default.png') }}" alt="{{ dept }}">
                    </div>
                    <div class="dept-name">{{ dept }}</div>
                </div>
            </div>
            {% endfor %}
        </div>

        <div id="hiddenInputs"></div>
        <button type="submit" id="submitBtn" disabled>Ti·∫øp t·ª•c ‚ûú</button>
    </form>

    {% if error %}
    <div class="error">{{ error }}</div>
    {% endif %}

    <div class="logout">
        <a href="/logout">‚Üê ƒêƒÉng xu·∫•t</a>
    </div>
</div>

<script>
const MAX = 3;

// Initialize with existing votes
window.addEventListener('DOMContentLoaded', function() {
    updateUI();
});

function selectedCards() {
    return Array.from(document.querySelectorAll('.vote-card.selected'));
}

function updateUI() {
    const n = selectedCards().length;
    document.getElementById('count').innerText = n;
    document.getElementById('submitBtn').disabled = (n !== MAX);

    const wrap = document.getElementById('hiddenInputs');
    wrap.innerHTML = '';
    selectedCards().forEach(card => {
        const dept = card.getAttribute('data-dept');
        const input = document.createElement('input');
        input.type = 'hidden';
        input.name = 'votes';
        input.value = dept;
        wrap.appendChild(input);
    });
}

function toggleSelect(card) {
    if (card.classList.contains('disabled')) return;

    const isSelected = card.classList.contains('selected');
    if (isSelected) {
        card.classList.remove('selected');
        updateUI();
        return;
    }

    const n = selectedCards().length;
    if (n >= MAX) return;
    
    card.classList.add('selected');
    updateUI();
}
</script>
{% endblock %}