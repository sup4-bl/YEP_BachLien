{% extends "base.html" %}

{% block title %}Vote Tiáº¿t Má»¥c{% endblock %}

{% block body %}
<div class="container">
    <h1>ğŸ­ Vote Tiáº¿t Má»¥c YÃªu ThÃ­ch</h1>
    <div class="info">
        <strong>{{ name }}</strong> - {{ department }}
    </div>
    <div class="warning">âš ï¸ Báº¡n khÃ´ng thá»ƒ bÃ¬nh chá»n cho tiáº¿t má»¥c thuá»™c nhÃ³m phÃ²ng ban cá»§a mÃ¬nh</div>
    <div class="hint">âœ… Báº¡n pháº£i chá»n <b>Ä‘Ãºng 3</b> tiáº¿t má»¥c Ä‘á»ƒ tiáº¿p tá»¥c</div>
    <div class="counter">ÄÃ£ chá»n: <span id="count">0</span>/3</div>

    <form method="POST" id="form">
        <div class="vote-grid">
            {% for dept in departments %}
            <div class="vote-card {% if dept in forbidden_options %}disabled{% endif %} {% if dept in existing_votes %}selected{% endif %}"
                data-dept="{{ dept }}"
                onclick="toggleSelect(this)">
                {% if dept in forbidden_options %}
                <span class="my-dept-badge">KhÃ´ng Ä‘Æ°á»£c vote</span>
                {% endif %}
                <div class="dept-content">
                    {% set parts = dept.split(' - ', 1) %}
                    <div class="dept-header">{{ parts[0] }}</div>
                    {% if parts|length > 1 %}
                    <div class="dept-subtitle">{{ parts[1] }}</div>
                    {% endif %}
                </div>
            </div>
            {% endfor %}
        </div>

        <div id="hiddenInputs"></div>
        <button type="submit" id="submitBtn" disabled>Tiáº¿p tá»¥c âœ</button>
    </form>

    {% if error %}
    <div class="error">{{ error }}</div>
    {% endif %}

    <div class="logout">
        <a href="/logout">â† ÄÄƒng xuáº¥t</a>
    </div>
</div>

<script>
const MAX = 3;

// Initialize with existing votes
window.addEventListener('DOMContentLoaded', function() {
    updateUI();
});

function selectedCards() {
    return Array.from(document.querySelectorAll('.vote-card.selected'));
}

function updateUI() {
    const n = selectedCards().length;
    document.getElementById('count').innerText = n;
    document.getElementById('submitBtn').disabled = (n !== MAX);

    const wrap = document.getElementById('hiddenInputs');
    wrap.innerHTML = '';
    selectedCards().forEach(card => {
        const dept = card.getAttribute('data-dept');
        const input = document.createElement('input');
        input.type = 'hidden';
        input.name = 'votes';
        input.value = dept;
        wrap.appendChild(input);
    });
}

function toggleSelect(card) {
    if (card.classList.contains('disabled')) return;

    const isSelected = card.classList.contains('selected');
    if (isSelected) {
        card.classList.remove('selected');
        updateUI();
        return;
    }

    const n = selectedCards().length;
    if (n >= MAX) return;
    
    card.classList.add('selected');
    updateUI();
}
</script>
{% endblock %}